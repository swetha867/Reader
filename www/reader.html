<html class="no-js">

<head>
  <title>Epub</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimal-ui, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/try.css">
  <link rel="stylesheet" href="css/popup.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css">
  <script src="js/jquery-2.1.0.js"></script>
  <script src="js/hammer.js"></script>
  <script src="js/jszip.min.js"></script>
  <script type="text/javascript" src="js/tipped.js"></script>
  <link rel="stylesheet" type="text/css" href="css/tipped.css" />

  <!--<script src="js/selectingword.js"></script>-->

  <script type="text/javascript" src="cordova.js"></script>

  <script>
    "use strict";

    document.onreadystatechange = function () {

      if (document.readyState == "complete") {

        EPUBJS.VERSION = "0.1.6";

        EPUBJS.filePath = "www/js/";
        EPUBJS.cssPath = "www/css/";

        ePubReader(localStorage.bookies);
        $('#screener').on('click', function () {
          console.log('go home');
          window.location.href = 'home.html';
        });
      }

      document.addEventListener("deviceready", onDeviceReady, false);
      function onDeviceReady() {
        AndroidFullScreen.immersiveMode();

        window.recognition = new SpeechRecognition();
        window.recognition.onresult = function (event) {
          if (event.results.length > 0) {
            //          q.value = event.results[0][0].transcript;
            //          q.form.submit();
            // console.log(event);
            // console.log(event.results[0][0].transcript);
            if (event.results[0][0].transcript == 'next') {
              // console.log('Next Page');
              window.mybook.nextPage();
            }
            if (event.results[0][0].transcript == 'previous') {
              // console.log('Previous Page');
              window.mybook.prevPage();
            }
          }
        }
      }
    };


  </script>

  <!-- Render -->
  <script src="js/epub.min.js"></script>
  <!-- Hooks -->
  <script src="js/hooks.min.js"></script>
  <!-- Reader -->
  <script src="js/reader.js"></script>
  <!-- Full Screen -->
  <script src="js/screenfull.min.js"></script>


  <style>
    #main {
      left: 0;
    }

    #main.single {
      width: 66%;
    }

    #main.single.closed {
      -webkit-transform: translate(51.6%, 0);
      -moz-transform: translate(51.6%, 0);
    }

    #sidebar {
      width: 50%
    }

    .hilite {
      background-color: lightblue;

    }

    #controls {
      position: absolute;
      bottom: 1vh;
      left: 30vw;
      width: 40vw;
      /*margin-left: -200px;*/
      text-align: center;
      display: none;
    }
  

    #controls>input[type=range] {
      width: 40vw;
    }
    /* #controls>img{
      width: 40vw;

    } */
    #summarize{
      text-rendering: auto;
      vertical-align: -15%;
      text-align: center;

    }


    #font-controls {
      position: absolute;
      bottom: 2vh;
      right: 65px;
      width: 50px;
      /*margin-left: -200px;*/
      text-align: center;
    }
    #summarize-controls {
      position: absolute;
      bottom: 1vh;
      right: 115px;
      width: 50px;
      /*margin-left: -200px;*/
      text-align: center;
    }
  </style>

</head>

<body>
  <div id="sidebar">
    <div id="panels">
      <a id="show-Toc" class="show_view icon-list-1 active" data-view="Toc">TOC</a>
      <a id="show-Bookmarks" class="show_view icon-bookmark" data-view="Bookmarks">Bookmarks</a>
     
      <!--<a id="gohome" class="show_view icon-edit" data-view="Notes">Notes</a>-->
      <!--<a id="show-Notes" class="show_view icon-edit" data-view="Notes">Notes</a>-->
    </div>
    <div id="tocView" class="view">
    </div>

    <div id="bookmarksView" class="view">
      <ul id="bookmarks"></ul>
    </div>

  </div>
  <div id="hypothesis"></div>
  <div id="main">
    <div id="titlebar">
      <div id="opener">
        <a id="slider" class="fa fa-bars"></a>
      </div>
      <div id="metainfo">
        <span id="book-title"></span>
        <span id="title-seperator">&nbsp;&nbsp;–&nbsp;&nbsp;</span>
        <span id="chapter-title"></span>
      </div>
      <div id="title-controls">
        <a id="bookmark" class="fa fa-bookmark-o">Bookmark</a>
      </div>
    </div>

    <div id="viewer"></div>

    <div id="popes">
      <span id="close" onclick="closePopes()"><span>✖</span></span>
      <div id="definitions">
        <div class="loader"></div>
      </div>
      <form id='votingForm' action="" style='padding-left:2%'></form>
    </div>
    <a id="screener" class="fa fa-times"></a>
    <div id="myPopup" class="definepop">
      <a id="opendefinition" class="button button-rounded button-primary">Define</a>
    </div>
    <a id="canceler" class="icon-cancel-circled"></a>
    <i id="speaker" class="fa fa-volume-up"></i>
    <i id="shutter" class="fa fa-volume-off"></i>
    <i id="listener" class="fa fa-microphone"></i>
    <div id="controls">
      <input id="currentpg" size="3" maxlength="3" /> / <span id="totalpg">0</span><br />
    </div>
    
    <div id="summarize-controls">
      <i id="summarize-icon">
        <img src="./img/summarizeicon.png" style="display:block;
      width:50px;
      height: 30px;
      " class="summarize">
       </i>
    </div>
       <div id="font-controls">

      <i id="define-icon" class="fa fa-book fa-lg"></i>
    </div>


    <!-- <div id="font-controls">
    <i id="font-small" class="fa fa-font fa-sm"></i>
    <i id="font-big" class="fa fa-font fa-lg"></i>
  </div> -->

    <div id="loadingscreen">
      <img class="loadingIcon" src="img/loader.gif">
      <!-- <p style="text-align: center">Generating page numbers...</p>
      <p style="text-align: center; font-size: small">(Only occurs when book is added for the first time.)</p> -->
    </div>
  </div>
  <div id="notes">
    <textarea id="note-pad" width="80%" height="80%"></textarea>
    <center><button id="noter" width="30%">Save</button></center>
  </div>


  <div id="loader"><img src="img/loader.gif"></div>
  </div>
  <div class="overlay"></div>

  <script type="text/javascript">
    function closePopes() {
      $('#popes').hide();
    }


    function openPopes() {
      $('#definitions').html('<div class="loader"></div>');
      $("#votingForm").html('');
      $('#popes').show();
    }

    // used for font size change in the reader page -- removed
    // $( "#font-small" ).click(function() {
    //   console.log("Decreasing font");
    //   fontSize = parseInt(mybook.settings.styles.fontSize.slice(0, -1));
    //   console.log("Current font size: " + fontSize);
    //   mybook.setStyle("fontSize", (fontSize - 10) + "%");
    //   mybook.generatePagination();
    // });


    // $( "#font-big" ).click(function() {
    //   console.log("Increasing font");
    //   fontSize = parseInt(mybook.settings.styles.fontSize.slice(0, -1));
    //   console.log("Current font size: " + fontSize);
    //   mybook.setStyle("fontSize", (fontSize + 10) + "%");
    //   mybook.generatePagination();
    // });


    $("#define-icon").click(function () {
      var word = mybook.renderer.render.window.getSelection().toString();
      if (word.length < 2) {
        alert("Please make a selection by long pressing on a word and sliding your finger.");
        return;
      }
      // alert(word);

      highlightElement(mybook.renderer.render.window.document, word);

      var contextSelection = mybook.renderer.render.window.getSelection();
      contextSelection.modify('extend', 'backward', 'sentenceboundary');
      var context = contextSelection.toString();
      contextSelection.modify('extend', 'forward', 'sentenceboundary');
      var context = context + contextSelection.toString();

      contextSelection.modify('extend', 'backward', 'paragraphboundary');
      var contextPara = contextSelection.toString();
      console.log("contextPara backward"+contextPara);
      contextSelection.modify('extend', 'forward', 'paragraphboundary');
      contextPara = contextPara + contextSelection.toString();
      //console.log("contextPara"+contextPara.toString());

      contextSelection.removeAllRanges();
      // alert(context);
      localStorage.sentence = context; // used in voting (legacy)
      localStorage.word=word;
      localStorage.paragraph=contextPara;
      // alert(window.bookKaMeta.bookTitle);
      // alert(window.bookKaMeta.creator);


      // return;
      openDefinitions(word,context);
    })
   function openDefinitions(word,sentence) {
    
      openPopes();

      var outputs = $.ajax({
        url: encodeURI('https://api.cognitive.microsoft.com/bing/v7.0/images/search?q=' + word),
        type: 'GET', // The HTTP Method, can be GET POST PUT DELETE etc
        timeout: 5000,
        data: {}, // Additional parameters here
        dataType: 'json',
        success: function (data) {
          var output = $.ajax({
            url: 'http://3.15.37.149:6010/lookup',
            type: 'POST',
            timeout: 8000,
            data: {
              word: word,
              user_id: window.localStorage.getItem("reader_user_id"),
              sentence: sentence,
              book_name: window.bookKaMeta.bookTitle,
              author_name: window.bookKaMeta.creator,
              paragraph:localStorage.paragraph,
            },
            dataType: 'json',
            success: function (dictionaryData) {
             var votedWords= $.ajax({
             url: "http://3.15.37.149:6010/votes/checkUserVote",
             type: "POST",
             data: {
              user_id: window.localStorage.getItem("reader_user_id"),
              sentence: sentence,
              book_name: window.bookKaMeta.bookTitle,
              author_name: window.bookKaMeta.creator,
              },
             dataType: 'json',
            success: function (votedWordsData) {   
           

              var meanings = [];
              meanings[0] = "Definition not found";
              meanings[1] = "";
              meanings[2] = "";
              var ogword = word;
              var definitions = '';
              var defNotFound = 0;
              var recheck = 0;

             let votedMeanings=[];
             votedWordsData.forEach(votedWord=>votedMeanings.push(votedWord.meaning_id));
            // console.log(groupBy(dictionaryData, dictionaryData.fl));
             let groupbyfl=groupBy(dictionaryData, 'fl');
             let arr=[];
            
             
            let myArray=[];

            console.log(groupbyfl);
            for (var key in groupbyfl) {
                for (var i = 0; i < groupbyfl[key].length; i++) {
                      myArray.push(groupbyfl[key][i]);
                  }
             }
             dictionaryData=myArray;
                   


              try {
                // && votedMeanings.includes(dictionaryData[i].id)
                if (dictionaryData.length != 0) {
                  for (var i = 0; i < dictionaryData.length; i++) {
                    if (dictionaryData[i].isTeacher == 1 && votedMeanings.includes(dictionaryData[i].id)) {
                      definitions += "<div class='aaa'><span class='ccc' ><label>" + dictionaryData[i].count + "</label></span><span class='bbb'><input type='radio' id=" + dictionaryData[i].id + " name = 'meaning_id' value=" + dictionaryData[i].id + " checked><label id='student' for=" + dictionaryData[i].id + "><b> " + dictionaryData[i].meaning + "</b>&nbsp;&nbsp; : " + dictionaryData[i].fl + "</label></span></div>";
                      recheck = 1;

                    }
                    else  if (dictionaryData[i].isTeacher == 1  ) {
                      definitions += "<div class='aaa'><span class='ccc' ><label>" + dictionaryData[i].count + "</label></span><span class='bbb'><input type='radio' id=" + dictionaryData[i].id + " name = 'meaning_id' value=" + dictionaryData[i].id + " ><label id='student' for=" + dictionaryData[i].id + "><b> " + dictionaryData[i].meaning + "</b>&nbsp;&nbsp; : " + dictionaryData[i].fl + "</label></span></div>";
                    }
                    else if (dictionaryData[i].isUser == 1 && votedMeanings.includes(dictionaryData[i].id)) {
                      definitions += "<div class='aaa'><span class='ccc' ><label>" + dictionaryData[i].count + "</label></span><span class='bbb'><input type='radio' id=" + dictionaryData[i].id + " name = 'meaning_id' value=" + dictionaryData[i].id + " checked><label for=" + dictionaryData[i].id + "><b> " + dictionaryData[i].meaning + "</b>&nbsp;&nbsp; : " + dictionaryData[i].fl + "</label></span></div>";
                      recheck = 1;
                    }
                    else if (votedMeanings.includes(dictionaryData[i].id)){
                      definitions += "<div class='aaa'><span class='ccc' ><label>" + dictionaryData[i].count + "</label></span><span class='bbb'><input type='radio' id=" + dictionaryData[i].id + " name = 'meaning_id' value=" + dictionaryData[i].id + " checked><label for=" + dictionaryData[i].id + "><b> " + dictionaryData[i].meaning + "</b>&nbsp;&nbsp; : " + dictionaryData[i].fl + "</label></span></div>";
                      recheck = 1;
                    }
                    else {
                      definitions += "<div class='aaa'><span class='ccc' ><label>" + dictionaryData[i].count + "</label></span><span class='bbb'><input type='radio' id=" + dictionaryData[i].id + " name = 'meaning_id' value=" + dictionaryData[i].id + "><label for=" + dictionaryData[i].id + "><b> " + dictionaryData[i].meaning + "</b>&nbsp;&nbsp; : " + dictionaryData[i].fl + "</label></span></div>";
                    }
                  }
                  if (recheck == 1) {
                    definitions += "<div class='aaa'><span class='ccc' ><label><b>?</b></label></span><span class='bbb'><input type='radio' id='notSure' name = 'meaning_id' value='0' ><label for='notSure'><b>Not Sure</b></label></span></div>";
                  }
                  else {
                    definitions += "<div class='aaa'><span class='ccc' ><label><b>?</b></label></span><span class='bbb'><input type='radio' id='notSure' name = 'meaning_id' value='0' checked><label for='notSure'><b>Not Sure</b></label></span></div>";
                  }
                  definitions += "<input type='hidden' id=" + dictionaryData[0].word_id + " name='word_id' value=" + dictionaryData[0].word_id + ">";

                }
                else {
                  definitions += "<h2>Definition not found</h2>"
                  defNotFound = 1;
                }

              } catch (err) {
                meanings[0] = "Definition not found";
              }

              localStorage.meaning = meanings[0];

              $("#close").html("<span>✖</span>");

              if (!$.trim(data.queryExpansions)) {
                $("#definitions").html("<div class='row'><div class='column left'><div class='container'><h1><center>Image Not Found!</center></h1></div><h2 class='remove-whitespace' style='padding-left:20px'>" + ogword + "</h2></div> <div class='column right'><div><div class='box green'></div>&nbsp;  Teacher Vote</div><br><div><div class='box checkmark active'></div> &nbsp; Your vote</div><br><div><div class='box'></div>&nbsp; Other Student Votes</div><br></div></div>");

                if (defNotFound != 1)
                  $("#votingForm").html(definitions + "<br><br><center><input type='submit' value='Vote'></center></form>");
              } else {
                $("#definitions").html("<div class='row'><div class='column left'><div class='container'><img class = 'photo' src ='" + data.value[0].thumbnailUrl + " width='250' height='250'/><img class='photo' src ='" + data.value[1].thumbnailUrl + " width='250' height='250'/><img class='photo' src ='" + data.value[2].thumbnailUrl + " width='250' height='250'/><img class='photo' src ='" + data.value[3].thumbnailUrl + " width='250' height='250'/><img class = 'photo' src ='" + data.value[4].thumbnailUrl + " width='250' height='250'/><img class = 'photo' src ='" + data.value[5].thumbnailUrl + " width='250' height='250'/></div><h2 class='remove-whitespace'>" + ogword.toLocaleUpperCase() + "</h2></div><div class='column right'><div><div class='box green'></div>&nbsp;  Teacher Vote</div><br><div><div class='box checkmark active'></div> &nbsp; Your vote</div><br><div><div class='box'></div>&nbsp; Other Student Votes</div><br></div></div>");
                if (defNotFound != 1)
                  $("#votingForm").html(definitions + "<br><center><input id='submit' type='submit' value='Vote'></center></form>");
              }
              if (defNotFound == 1) {
                $("#votingForm").html("<b>Definition not found</b>");
              }
            },
            complete: function () {
              if (window.localStorage.getItem("reader_user_is_teacher") == "1") {
                $("#votingForm").append("<div style='padding: 10px 0'><a href='javascript:addCustomDef(\"" + word + "\")'>Add a custom definition</a>");
              }
              if (localStorage.meaning.length > 1 && localStorage.meaning != "Definition not found") {
                var db = window.sqlitePlugin.openDatabase({ name: 'demo.db', location: 'default' });

                db.transaction(function (tx) {
                  tx.executeSql('CREATE TABLE IF NOT EXISTS WordsTable (word, meaning, sentence, frequency, book)');
                  tx.executeSql("SELECT count(*) AS mycount FROM WordsTable where word='" + localStorage.word + "' ", [], function (tx, rs) {
                    // console.log('Record count : ' + rs.rows.item(0).mycount);
                    // console.log(rs);
                    if (rs.rows.item(0).mycount == 0) {
                      db.transaction(function (tx) {
                        //tx.executeSql('DROP TABLE IF EXISTS WordsTable');
                        tx.executeSql('INSERT INTO WordsTable VALUES (?,?,?,?,?)', [localStorage.word, localStorage.meaning, localStorage.sentence, 1, window.bookKaMeta.bookTitle]);
                      }, function (error) {
                        console.log('Transaction ERROR: ' + error.message);
                      }, function () {
                        // console.log('Inserted');
                      });
                    }
                    else {
                      db.transaction(function (tx) {
                        tx.executeSql("Update WordsTable Set frequency = frequency + 1 WHERE word='" + localStorage.word + "' ");
                      }, function (error) {
                        console.log('Transaction ERROR: ' + error.message);
                      }, function () {
                        console.log('Incremented');
                      });
                    }
                  }, function (tx, error) {
                    console.log('SELECT error: ' + error.message);
                  }, function () {
                    console.log('Recorded');
                  });
                });
              }
            },
            error: function (err) {
          if (err.statusText == 'timeout') alert('Connection timeout!');
          else alert("Error loading! Are you connected to the internet?");
          closePopes();
            }
          })
        },
            error: function (err) {
              if (err.statusText == 'timeout') alert('Connection timeout!');
              else alert("Error loading! Are you connected to the internet?");
              closePopes();
            }
          });//output ajax
        },
        error: function (err) {
          if (err.statusText == 'timeout') alert('Connection timeout!');
          else alert("Error loading! Are you connected to the internet?");
          closePopes();
        },
        beforeSend: function (xhr) {
          xhr.setRequestHeader("Ocp-Apim-Subscription-Key", "457dba72ab0347b28f31e688d4a332e5");
          //xhr.setRequestHeader("Access-Control-Allow-Origin", "*");// Enter here your Mashape key
        }

      
    
  })// outputs ajax

      // var elements = mybook.renderer.doc.querySelectorAll('p'),
      //   //Perform actions on each of the elements. Each item is paragraph in book html
      //   items = Array.prototype.slice.call(elements);
      // items.forEach(function (item) {
      //   var array_of_sentences = (item.innerText.split("."));
      //   for (var i = 0; i < array_of_sentences.length; i++) {
      //     var single = array_of_sentences[i];
      //     alert(single);
      //     // if (single.includes(t))
      //     //   localStorage.sentence = array_of_sentences[i];
      //   }
      // });
    };
    const groupBy = (array, key) => {
  // Return the end result
  return array.reduce((result, currentValue) => {
    // If an array already present for key, push it to the array. Else create an array and push the object
    (result[currentValue[key]] = result[currentValue[key]] || []).push(
      currentValue
    );
    // Return the current iteration `result` value, this will be taken as next iteration `result` value and accumulate
    return result;
  }, {}); // empty object is the initial value for result object
};

   

    $("#votingForm").on('submit', function (e) {
      e.preventDefault();
      var result = {};
      $.each($(this).serializeArray(), function () {
        result[this.name] = this.value;
      });

      $.ajax({
        type: "POST",
        url: "http://3.15.37.149:6010/votes",
        data: {
          user_id: window.localStorage.getItem('reader_user_id'),
          meaning_id: result.meaning_id,
          word_id: result.word_id,
          sentence: localStorage.sentence,
          book_name: window.bookKaMeta.bookTitle,
          author_name: window.bookKaMeta.creator,
        },
        success: function (data) {
          // console.log(data);
          alert("Vote Saved");
        },
        complete: function (data) {
          openDefinitions(localStorage.word,localStorage.sentence) 
        }
      });
    });

    function addCustomDef(word) {
      var def = prompt("Please enter the new definition", "");
      if (def != null && def != "") {
        var fl = prompt("Please enter type (noun, verb,...)", "");
        if (fl != null && fl != "") {
          $.ajax({
            type: "POST",
            url: "http://3.15.37.149:6010/votes/custom",
            data: {
              user_id: window.localStorage.getItem('reader_user_id'),
              word: word,
              sentence: localStorage.sentence,
              book_name: window.bookKaMeta.bookTitle,
              author_name: window.bookKaMeta.creator,
              def: def,
              fl: fl
            },
            success: function (data) {
              if (typeof data['err'] != 'undefined' && data['err'] != "") {
                alert(data['err']);
                return;
              }
              alert("New definition Saved");
            },
            complete: function (data) {
              
              closePopes();
            }
          });
        }
      }
    }

    // ['trouble', ...];
    async function getLookedUpWordsForBook() {
      return new Promise(resolve => {
        $.ajax({
          type: "POST",
          url: "http://3.15.37.149:6010/votes/getAllForHighlight",
          data: {
            user_id: window.localStorage.getItem('reader_user_id'),
            book_name: window.bookKaMeta.bookTitle,
            author_name: window.bookKaMeta.creator,
          },
          success: function (data) {
            if (data.res == 'success') {
              console.log(data.words);
              resolve(data.words);
            } else {
              resolve([]);
            }
          },
          error: function (data) {
            resolve([]);
          }
        })
      });
    }


    // function highlightElement(el, w) {
    //   console.log(el);
    //   console.log($(el).children().length);
    //   if ($(el).children().length != 0) {
    //     $(el).children().each(function () {
    //       highlightElement(this, w);
    //     });
    //     return;
    //   }
    //   if ($(el).text().includes(w)) {
    //     $(el).html(function (i, text) {
    //       var regex = new RegExp(w, "gi");
    //       return text.replace(regex, '<span style="color: red">' + w + '</span>');
    //     });
    //   }
    // }

    function  highlightElement(el, w) {
      // encode html chars
      var w = w.replace(/[\u00A0-\u9999<>\&]/gim, function (i) {
        return '&#' + i.charCodeAt(0) + ';';
      });

      if (w.length < 4) return; // try to avoid getting html elements.
      var elements = el.querySelectorAll('p'),
        items = Array.prototype.slice.call(elements);
      items.forEach(function (item) {
        if ($(item).text().includes(w)) {
          // $(item).css('color', 'red');
          $(item).html(function (i, text) {
            // console.log(text);
            var regex = new RegExp(w, "gi");
            return text.replace(regex, '<span style="color: red">' + w + '</span>');
          });
        }
      });
    }

    async function highlightSelectedWords(renderer) {
      words = await getLookedUpWordsForBook();
      var chapter = renderer.currentChapter;
      words.forEach(function (w) {
        highlightElement(renderer.doc, w);
      });
    }
  </script>
</body>

</html>